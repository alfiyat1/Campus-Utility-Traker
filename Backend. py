from fastapi import FastAPI, UploadFile, File
from pydantic import BaseModel
from sentence_transformers import SentenceTransformer, util
import uvicorn
import numpy as np
from fastapi.middleware.cors import CORSMiddleware

# Create app
app = FastAPI()

# Enable CORS so HTML can call backend
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Load model
model = SentenceTransformer("all-MiniLM-L6-v2")

# Example jobs
JOBS = [
    {"id": "1", "title": "Python Developer", "description": "Python, Django, APIs"},
    {"id": "2", "title": "Data Scientist", "description": "Machine learning, pandas, sklearn, Python"},
    {"id": "3", "title": "Frontend Developer", "description": "HTML, CSS, JavaScript, React"},
]

class ResumeIn(BaseModel):
    text: str

def match_resume(resume_text):
    job_texts = [job["description"] for job in JOBS]

    job_embeddings = model.encode(job_texts, convert_to_tensor=True)
    resume_embedding = model.encode([resume_text], convert_to_tensor=True)[0]

    scores = util.cos_sim(resume_embedding, job_embeddings)[0].cpu().numpy()
    top = np.argsort(-scores)[:5]

    results = []
    for i in top:
        results.append({
            "job_id": JOBS[i]["id"],
            "title": JOBS[i]["title"],
            "score": float(scores[i])
        })
    return results

@app.post("/match")
async def match(resume: ResumeIn):
    return {"matches": match_resume(resume.text)}

@app.post("/upload_resume")
async def upload_resume(file: UploadFile = File(...)):
    text = (await file.read()).decode("utf-8")
    return {"matches": match_resume(text)}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
